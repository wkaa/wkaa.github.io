---
layout: post
title: PPPoE学习（一）---PPPoE会话建立流程
categories: PPPoE
description: 介绍PPPoE会话建立流程
keywords: PPPoE
---

　　介绍一下PPPoE会话建立流程，来源于RFC2516

## PPPoE会话建立流程

　　首先看一下PPPoE会话是如何建立的，简要概括一下就是分为一下四个步骤

```
1. Host广播发送PADI
2. 多个Server单播回复PADO
3. Host选择一个Server单播发送PADR
4. Server单播回复PADS返回Session ID建立会话
```

### PPPoE帧格式

                           1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Dst_mac_addr                          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      Dst_mac_addr (cont)      |         Source_mac_addr       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                    Source_mac_addr (cont)                     |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  ETHER_TYPE = 0x8863、0x8864  | v = 1 | t = 1 |     CODE      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |          SESSION_ID           |          LENGTH               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                              payload        ~
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |           TAG_TYPE            |        TAG_LENGTH             |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                              VALUE        ~
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

　　当ETHER_TYPE类型为0×8863时，表示payload承载的是PPPoE协商报文，当类型为0×8864时，表示承载的是PPPoE的会话数据报文，Payload部分就是PPPoE报文的内容了。

　　版本、类型字段的数值恒为0×01（各4bit），Code字段在各种报文中的数值不同,在后面会一一介绍.会话ID表示此报文为哪个PPPoE会话的报文。长度字段表示后面Payload字段的长度，在这个层次上的Payload是一组的PPPoE标记（Tag）。

　　最后是PPPoE Tag的组织格式，是以一串常见的TLV（类型、长度、值）三元组组成的。

### Discovery阶段

#### PPPoE Active Discovery Initiation 数据包(PADI)

　　主机发送 DESTINATION_ADDR 为广播地址的 PADI 数据包， CODE 域设置为
0x09,SESSION_ID 域必须设置为 0x0000。

　　PADI 数据包包含：

　　　　TAG_TYPE 为 Service-Name 的 TAG。 它表示主机请求的服务（必须有，而且
只能有一个）

　　　　任意数目的其它类型的 TAG。

　　整个 PADI 数据包（包括 PPPoE 头部）不允许超过 1484 个字节，以留足空间让中继代理（向数据包中）增加类型为 Relay-Session-Id 的 TAG。

                           1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         0xffffffff                            |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |           0xffff              |        Host_mac_addr          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                    Host_mac_addr (cont)                       |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |    ETHER_TYPE = 0x8863        | v = 1 | t = 1 |  CODE = 0x09  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     SESSION_ID = 0x0000       |      LENGTH = 0x0004          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      TAG_TYPE = 0x0101        |    TAG_LENGTH = 0x0000        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

　　0x0101 Service-Name该 TAG 表明后面紧跟的是服务的名称。 TAG_VALUE 是不以 NULL 结束的 UTF-8 字符串。当 TAG_LENGTH为 0时，该 TAG用于表明接受任何服务。使用 Service-Name标签的例子是表明 ISP(Internet 服务提供商)或者一类服务或者服务的质量。

#### PPPoE Active Discovery Offer 数据包(PADO)

　　如果接入集线器能够为收到的 PADI 请求提供服务，它将通过发送一个 PADO 数据包来做出应答。 DESTINATION_ADDR 为发送 PADI 的主机的单播地址， CODE 域为0x07,SESSION_ID 域必须设置为 0x0000。

　　PADO 数据包必须包含：

　　　　TAG_TYPE 为 AC-Name 的 TAG（包含了访问集中器的名字）

　　　　与 PADI 中相同的 TAG_TYPE 为 Service-Name 的 TAG

　　　　任意数目的类型为 Service-Name 的 TAG 表明接入集线器提供的其它服务。

　　如果接入集线器不能为 PADI 提供服务，则不允许用 PADO 作响应。

                           1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         Host_mac_addr                         |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      Host_mac_addr (cont)     | Access_Concentrator_mac_addr  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |             Access_Concentrator_mac_addr (cont)               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |    ETHER_TYPE = 0x8863        | v = 1 | t = 1 |  CODE = 0x07  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     SESSION_ID = 0x0000       |      LENGTH = 0x0020          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      TAG_TYPE = 0x0101        |    TAG_LENGTH = 0x0000        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      TAG_TYPE = 0x0102        |    TAG_LENGTH = 0x0018        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     0x47      |     0x6f      |     0x20      |     0x52      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     0x65      |     0x64      |     0x42      |     0x61      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     0x63      |     0x6b      |     0x20      |     0x2d      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     0x20      |     0x65      |     0x73      |     0x68      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     0x73      |     0x68      |     0x65      |     0x73      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     0x68      |     0x6f      |     0x6f      |     0x74      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

　　0x0102 AC-Name，该 TAG 表明后面紧跟的字符串唯一地表示了某个特定的接入集线器。它可以是商标、型号以及序列号等信息的集合，或者该接入集线器 MAC 地址的一个简单的 UTF-8 表示。它不以 NULL 来结束。

#### PPPoE Active Discovery Request 数据包(PADR)

　　由于 PADI 是广播的,主机可能收到不止一个 PADO,它将审查接收到的所有 PADO 并从中选择一个。可以根据其中的 AC-Name 或 PADO 所提供的服务来作出选择。然后主机向选中的访问集中器发送一个 PADR 数据包。其中， DESTINATION_ADDR 域设置为发送 PADO 的接入集线器的单播地址， CODE域设置为 0x19， SESSION_ID 必须设置为 0x0000。

　　PADR 必须包含：

　　　　包含且仅包含一个 TAG_TYPE 为 Service-Name 的 TAG，表明主机请求的服务

　　　　任意数目其他类型的 TAG。

                          1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          Server_mac_addr                      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      Server_mac_addr (cont)   |        Host_mac_addr          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                      Host_mac_addr (cont)                     |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |    ETHER_TYPE = 0x8863        | v = 1 | t = 1 |  CODE = 0x19  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     SESSION_ID = 0x0000       |      LENGTH = 0x0004          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      TAG_TYPE = 0x0101        |    TAG_LENGTH = 0x0000        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

#### PPPoE Active Discovery Session-confirmation 数据包(PADS)

　　当接入集线器收到一个 PADR 数据包，它就准备开始一个 PPP 会话。它为 PPPoE 会话创 建一个唯一的SESSION_ID 并用一个PADS数据包来给主机作出响应 。

　　DESTINATION_ADDR 域为发送 PADR 数据包的主机的单播以太网地址，CODE 域设置为 0x65,SESSION_ID 必须设置为所创建好的 PPPoE 会话标识符。

　　PADS 数据包包含：

　　　　且仅包含一个 TAG_TYPE 为 Service-Name 的 TAG，表明接入集线器已经接受
了该 PPPoE 会话的服务类型

　　　　任意数目的其他类型的 TAG如果接入集线器不喜欢 PADR 中的 Service-Name,那么它必须用一个带有类型为

　　Service-Name-Error 的 TAG(以及任意数目的其它 TAG 类型)的 PADS 来作出应答。这种情况下， SESSION_ID 必须设置为 0x0000。

                          1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          Host_mac_addr                        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      Host_mac_addr (cont)     |        Server_mac_addr        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                      Server_mac_addr (cont)                   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |    ETHER_TYPE = 0x8863        | v = 1 | t = 1 |  CODE = 0x65  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     SESSION_ID = 0x0001       |      LENGTH = 0x0004          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      TAG_TYPE = 0x0101        |    TAG_LENGTH = 0x0000        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

### PPP会话阶段

　　完成以上的步骤后建立了PPPoE会话，之后就可以使用PPP建立会话开始通信，这个之后进行介绍

　　ETHER_TYPE为0x8864，PPP的LCP报文如下：

                           1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                  Access_Concentrator_mac_addr                 |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |Access_Concentrator_mac_addr(c)|        Host_mac_addr          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                     Host_mac_addr (cont)                      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |    ETHER_TYPE = 0x8864        | v = 1 | t = 1 |  CODE = 0x00  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     SESSION_ID = 0x1234       |      LENGTH = 0x????          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |    PPP PROTOCOL = 0xc021      |        PPP payload            ~
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


